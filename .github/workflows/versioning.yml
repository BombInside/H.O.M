name: ğŸ”– Auto Version Tagging

on:
  push:
    branches:
      - main

jobs:
  tag-and-push:
    name: ğŸ§© Generate version and push images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§® Determine version
        id: version
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¸Ğ· Ñ‚ĞµĞ³Ğ¾Ğ² Git, ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ â€” Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ v0.4.1
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.4.1")
          echo "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞ³: $last_tag"

          # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ patch-Ğ²ĞµÑ€ÑĞ¸Ñ
          base=${last_tag#v}
          IFS='.' read -r major minor patch <<<"$base"
          patch=$((patch + 1))
          new_tag="v${major}.${minor}.${patch}"

          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞ³: $new_tag"

      - name: ğŸ·ï¸ Create new Git tag
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.version.outputs.new_tag }}
          git push origin ${{ steps.version.outputs.new_tag }}

      - name: ğŸ”‘ Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Build and push backend image
        run: |
          docker build -t ghcr.io/bombinside/hom-backend:latest ./backend
          docker tag ghcr.io/bombinside/hom-backend:latest ghcr.io/bombinside/hom-backend:${{ steps.version.outputs.new_tag }}
          docker push ghcr.io/bombinside/hom-backend:latest
          docker push ghcr.io/bombinside/hom-backend:${{ steps.version.outputs.new_tag }}

      - name: ğŸ’» Build and push frontend image
        run: |
          docker build -t ghcr.io/bombinside/hom-frontend:latest ./frontend
          docker tag ghcr.io/bombinside/hom-frontend:latest ghcr.io/bombinside/hom-frontend:${{ steps.version.outputs.new_tag }}
          docker push ghcr.io/bombinside/hom-frontend:latest
          docker push ghcr.io/bombinside/hom-frontend:${{ steps.version.outputs.new_tag }}

      - name: âœ… Done
        run: echo "ğŸ‰ Tagged and published ${{ steps.version.outputs.new_tag }} successfully!"
